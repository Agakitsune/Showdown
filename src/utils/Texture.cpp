
#include "utils/Texture.hpp"

#define STB_IMAGE_IMPLEMENTATION
#include "stb_image.h"

#ifdef SHOWDOWN_DEBUG
    #include "utils/Debug.hpp"
#endif

const unsigned char defaultTextureData[16][16 * 3] = {
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    {0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff,   0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05},
    
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
    {0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05, 0x05,0x05,0x05,   0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff, 0xff,0x00,0xff},
};

namespace showdown::utils {

    gl::Texture loadTexture(const std::string &path) {
        int width, height, channels;
        unsigned char *data = stbi_load(path.c_str(), &width, &height, &channels, 0);
        if (data == nullptr) {
            throw std::runtime_error("Failed to load texture: " + path);
        }

        #ifdef SHOWDOWN_DEBUG
            showdown::debug("Texture") << "Loading: " << path << std::endl;
            showdown::debug("Texture") << "Width: " << width << std::endl;
            showdown::debug("Texture") << "Height: " << height << std::endl;
            showdown::debug("Texture") << "Channels: " << channels << std::endl;
        #endif

        gl::Texture texture;
        texture.bind(gl::TextureTarget::Texture2D);
        texture.setTextureParameter(gl::TextureParameterName::WrapS, gl::TextureWrap::Repeat);
        texture.setTextureParameter(gl::TextureParameterName::WrapT, gl::TextureWrap::Repeat);
        texture.setTextureParameter(gl::TextureParameterName::MinFilter, gl::TextureFilter::NearestMipmapNearest);
        texture.setTextureParameter(gl::TextureParameterName::MagFilter, gl::TextureFilter::Nearest);
        if (channels == 3)
            texture.data2D(0, gl::TextureInternalFormat::RGB, width, height, gl::TextureFormat::RGB, gl::TextureDataType::UnsignedByte, data);
        else if (channels == 4)
            texture.data2D(0, gl::TextureInternalFormat::RGBA, width, height, gl::TextureFormat::RGBA, gl::TextureDataType::UnsignedByte, data);
        texture.generateMipmap();
        stbi_image_free(data);
        return texture;
    }

    gl::Texture loadDefault() {
        if (utils::defaultTextureLoaded) {
            return defaultTexture;
        }
        defaultTexture.bind(gl::TextureTarget::Texture2D);
        defaultTexture.data2D(0, gl::TextureInternalFormat::RGB, 16, 16, gl::TextureFormat::RGB, gl::TextureDataType::UnsignedByte, defaultTextureData);
        defaultTexture.setTextureParameter(gl::TextureParameterName::WrapS, gl::TextureWrap::Repeat);
        defaultTexture.setTextureParameter(gl::TextureParameterName::WrapT, gl::TextureWrap::Repeat);
        defaultTexture.setTextureParameter(gl::TextureParameterName::MinFilter, gl::TextureFilter::NearestMipmapNearest);
        defaultTexture.setTextureParameter(gl::TextureParameterName::MagFilter, gl::TextureFilter::Nearest);
        defaultTexture.generateMipmap();
        utils::defaultTextureLoaded = true;
        return defaultTexture;
    }

}
